<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>С новым годом, томичи!</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="../css/video-style.css" />
</head>

<body>
    <div id="loading">
        <img src="../Data/logo.gif" />
        <span class="loading-text">Загрузка, пожалуйста подождите...</span>
    </div>

    <!--
      ==================
      CAMERA VIDEO & CANVAS
      ==================
      -->

    <div id="app">
        <video loop autoplay muted playsinline id="video"></video>
        <canvas id="canvas" style="visibility: visible;"></canvas>
    </div>
    <canvas id="photoCanvas" width="640" height="400" style="width: 640px; height: 480px;"></canvas>


    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.0.0-rc.5/dist/html2canvas.min.js"></script>
    <script src="ua-parser.min.js"></script>
    <script src="FileSaver.js"></script>
    <script src="canvas-toBlob.js"></script>

    <script type="text/javascript">
        var canvas;
        var photoCanvas;
        var video;
        var PCContext;
        var counter = 0;

        var globalsSetup = false;
        setTimeout(setGlobals, 1200);

        function setGlobals() {
            canvas = document.getElementById("canvas");
            video = document.getElementById('video');

            photoCanvas = document.getElementById("photoCanvas");
            PCContext = photoCanvas.getContext('2d');
            console.log(canvas);
            console.log(video);
            console.log(photoCanvas);
            console.log(PCContext);
            globalsSetup = true;
        }


        function TakeScreenshot() {
            //let video = document.getElementById('video');
            //let savedVisibility = canvas.style.visibility;
            PCContext.drawImage(video, 0, 0, 600, 400, 0, 0, 600, 400);
            PCContext.drawImage(canvas, 0, 0, 600, 400, 0, 0, 600, 400);

            photoCanvas.toBlob(function(blob) {
                counter += 1;
                saveAs(blob, "Photo_with_snowman_" + counter.toString());
            });
            //html2canvas(document.getElementById('app')).then(function(temp_canvas) {
            //    temp_canvas.toBlob(function(blob) {
            //        counter += 1;
            //        saveAs(blob, "Photo_with_snowman_" + counter.toString());
            //    });
            //});
            canvas.style.visibility = "visible";
        }


        function TakeScreenshotWrapper() {
            if (globalsSetup) {
                canvas.style.visibility = "hidden";
                setTimeout(TakeScreenshot, 500);
            }
        }
    </script>

    <button onclick="TakeScreenshotWrapper()" style="outline: none;">
  <img src="t2.png" style="
  position: absolute;
  z-index: 99999999;
  width: 5pc;
  height: 4pc;
  left: 50%;
  top: 100%;
  margin-left: -2.5pc;
  margin-top: -7.5pc;">
  </button>

    <script src="../js/third_party/three.js/stats.min.js"></script>
    <script src="../js/third_party/three.js/three.min.js"></script>
    <script src="../js/third_party/three.js/GLTFLoader.js"></script>
    <script src="threejs_worker_gltf.js"></script>

    <script>
        /**
         * APP / ELEMENTS
         */
        var container = document.getElementById("app");
        var video = document.getElementById("video");
        var canvas = document.getElementById("canvas");

        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            var hint = {
                audio: false,
                video: true
            };

            if (window.innerWidth < 800) {
                hint = {
                    audio: false,
                    video: {
                        width: {
                            ideal: 480
                        },
                        height: {
                            ideal: 640
                        },
                        facingMode: {
                            exact: "environment"
                        }
                    },
                };
            }

            navigator.mediaDevices.getUserMedia(hint).then(function(stream) {
                video.srcObject = stream;
                video.addEventListener("loadedmetadata", function() {
                    video.play();

                    start(
                        container,
                        markers["qr_code_prelegacy"],
                        video,
                        video.videoWidth,
                        video.videoHeight,
                        canvas,
                        null,
                        null,
                        null
                    );
                });
            });
        }
    </script>
</body>

</html>